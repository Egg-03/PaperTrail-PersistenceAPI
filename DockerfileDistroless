# Stage 1: Build native image
FROM ghcr.io/graalvm/native-image-community:24 AS build
WORKDIR /app

COPY pom.xml mvnw .mvn/ ./
RUN chmod +x ./mvnw
RUN ./mvnw dependency:go-offline

COPY src ./src
RUN ./mvnw -Pnative clean package -DskipTests

# Make the binary executable
RUN chmod +x target/*-runner

# Stage 2: Runtime image
FROM gcr.io/distroless/base-debian11 AS runtime
WORKDIR /app
VOLUME /tmp

COPY --from=build /app/target/*-runner /app/persistence

EXPOSE 8081
ENTRYPOINT ["/app/persistence", "--spring.profiles.active=prod"]
