# Stage 1: Build GraalVM native image
FROM ghcr.io/graalvm/native-image-community:24 AS build
WORKDIR /app

# Copy all necessary files
COPY pom.xml mvnw ./
COPY .mvn .mvn
COPY src ./src

# Prepare Maven wrapper
RUN chmod +x ./mvnw
RUN ./mvnw dependency:go-offline

# Build native image using Spring Boot native profile
RUN ./mvnw -Pnative clean package -DskipTests
RUN chmod +x target/*-runner  # make executable here

# Stage 2: Minimal runtime image
FROM gcr.io/distroless/base-debian11 AS runtime
WORKDIR /app
VOLUME /tmp

# Copy native binary
COPY --from=build /app/target/*-runner /app/persistence

# Expose port and run
EXPOSE 8081
ENTRYPOINT ["/app/persistence", "--spring.profiles.active=prod"]
